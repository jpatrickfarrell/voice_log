{% extends "base.html" %}

{% block title %}{{ post.title }} - Voice Log{% endblock %}

{% block head %}
<meta name="description" content="{{ post.summary or 'Listen to this voice post on Voice Log' }}">
<meta property="og:title" content="{{ post.title }}">
<meta property="og:description" content="{{ post.summary or 'Listen to this voice post on Voice Log' }}">
<meta property="og:type" content="article">
<meta property="og:audio" content="{{ url_for('posts.serve_audio', filename=post.audio_filename, _external=True) }}">
<meta name="twitter:card" content="player">
<meta name="twitter:player" content="{{ url_for('posts.view_post', slug=post.slug, _external=True) }}">
{% endblock %}

{% block content %}
<div class="post-view">
    <!-- Post Header -->
    <header class="post-header">
        <div class="post-breadcrumb">
            <a href="{{ url_for('main.index') }}">Home</a>
            <i class="bi bi-chevron-right"></i>
            <a href="{{ url_for('main.discover') }}">Discover</a>
            <i class="bi bi-chevron-right"></i>
            <span>{{ post.title }}</span>
        </div>
        
        <div class="post-title-section">
            <h1 class="post-title">{{ post.title }}</h1>
            
            <div class="post-metadata">
                <div class="post-author">
                    <i class="bi bi-person-circle"></i>
                    <span>{{ author.username if author else 'Anonymous' }}</span>
                </div>
                
                <div class="post-date">
                    <i class="bi bi-calendar3"></i>
                    <time datetime="{{ post.created_at }}">{{ post.created_at }}</time>
                </div>
                
                <div class="post-duration">
                    <i class="bi bi-clock"></i>
                    <span>{{ post.format_duration() }}</span>
                </div>
                
                {% if post.privacy_level == 'unlisted' %}
                <div class="privacy-badge unlisted">
                    <i class="bi bi-eye-slash"></i>
                    <span>Unlisted</span>
                </div>
                {% elif post.privacy_level == 'private' %}
                <div class="privacy-badge private">
                    <i class="bi bi-lock"></i>
                    <span>Private</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="post-actions">
            {% if current_user.is_authenticated and current_user.id == post.user_id %}
                <a href="{{ url_for('posts.edit_post', slug=post.slug) }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-pencil"></i> Edit
                </a>
            {% endif %}
            
            <button class="btn btn-outline-secondary btn-sm" onclick="sharePost('{{ post.title }}', '{{ url_for('posts.view_post', slug=post.slug, _external=True) }}')">
                <i class="bi bi-share"></i> Share
            </button>
            
            <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('{{ url_for('posts.view_post', slug=post.slug, _external=True) }}', 'Link copied!')">
                <i class="bi bi-link-45deg"></i> Copy Link
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="post-content">
        <div class="post-main">
            <!-- Summary -->
            {% if post.summary %}
            <div class="post-summary-card">
                <h3>Summary</h3>
                <p id="summary">{{ post.summary }}</p>
            </div>
            {% endif %}
            
            <!-- Audio Player -->
            <div class="audio-player-section">
                <h3>Listen to this post</h3>
                <div class="audio-player">
                    <audio controls preload="metadata" data-post-slug="{{ post.slug }}">
                        <source src="{{ post.get_audio_url() }}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                </div>
            </div>
            
            <!-- Transcript -->
            {% if post.transcript %}
            <div class="transcript-section">
                <div class="transcript-header">
                    <h3>Transcript</h3>
                    <div class="transcript-actions">
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard(document.getElementById('transcript').textContent, 'Transcript copied!')">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="post-transcript" id="transcript">
                    {{ post.transcript }}
                </div>
            </div>
            {% endif %}
            
            <!-- Processing Button for Owner -->
            {% if current_user.is_authenticated and current_user.id == post.user_id and not post.transcript %}
            <div class="processing-section">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    This post hasn't been processed yet. Generate transcript and summary?
                </div>
                <button class="btn btn-primary" onclick="processPost('{{ post.slug }}')" data-process-slug="{{ post.slug }}">
                    <i class="bi bi-cpu"></i> Generate Transcript & Summary
                </button>
            </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div class="post-sidebar">
            <!-- Post Stats -->
            <div class="stats-widget">
                <h4>Post Statistics</h4>
                <div class="stats-list">
                    <div class="stat-item">
                        <i class="bi bi-eye"></i>
                        <span class="stat-label">Views</span>
                        <span class="stat-value">{{ analytics.view_count }}</span>
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-play-circle"></i>
                        <span class="stat-label">Plays</span>
                        <span class="stat-value">{{ analytics.play_count }}</span>
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-calendar3"></i>
                        <span class="stat-label">Published</span>
                        <span class="stat-value">{{ post.created_at }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Author Info -->
            {% if author %}
            <div class="author-widget">
                <h4>About the Author</h4>
                <div class="author-info">
                    <div class="author-avatar">
                        <i class="bi bi-person-circle"></i>
                    </div>
                    <div class="author-details">
                        <div class="author-name">{{ author.username }}</div>
                        <div class="author-posts">{{ author.get_post_count() }} posts</div>
                    </div>
                </div>
                <a href="{{ url_for('api.user_posts', username=author.username) }}" class="btn btn-sm btn-outline-primary w-100">
                    View All Posts
                </a>
            </div>
            {% endif %}
            
            <!-- Related Actions -->
            <div class="actions-widget">
                <h4>Actions</h4>
                <div class="action-buttons">
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="sharePost('{{ post.title }}', '{{ url_for('posts.view_post', slug=post.slug, _external=True) }}')">
                        <i class="bi bi-share"></i> Share Post
                    </button>
                    
                    {% if current_user.is_authenticated %}
                        {% if current_user.id == post.user_id %}
                        <a href="{{ url_for('posts.edit_post', slug=post.slug) }}" class="btn btn-outline-secondary w-100 mb-2">
                            <i class="bi bi-pencil"></i> Edit Post
                        </a>
                        {% endif %}
                        <a href="{{ url_for('posts.create_post') }}" class="btn btn-success w-100">
                            <i class="bi bi-plus-circle"></i> Create Your Own
                        </a>
                    {% else %}
                        <a href="{{ url_for('auth.register') }}" class="btn btn-success w-100">
                            <i class="bi bi-person-plus"></i> Join Voice Log
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.post-view {
    max-width: none;
}

.post-header {
    background: var(--bg-main);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
}

.post-breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    color: var(--text-muted);
}

.post-breadcrumb a {
    color: var(--text-muted);
    text-decoration: none;
}

.post-breadcrumb a:hover {
    color: var(--primary-main);
}

.post-title-section {
    margin-bottom: 1.5rem;
}

.post-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1rem;
    line-height: 1.3;
}

.post-metadata {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    align-items: center;
}

.post-author,
.post-date,
.post-duration {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.privacy-badge {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 500;
}

.privacy-badge.unlisted {
    background: rgba(245, 158, 11, 0.1);
    color: var(--secondary-orange);
}

.privacy-badge.private {
    background: rgba(239, 68, 68, 0.1);
    color: #EF4444;
}

.post-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.post-content {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 2rem;
}

.post-main {
    min-width: 0;
}

.post-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.post-summary-card {
    background: var(--bg-main);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
}

.post-summary-card h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.post-summary-card p {
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 0;
    font-size: 1rem;
}

.audio-player-section {
    background: var(--bg-main);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
}

.audio-player-section h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.audio-player {
    background: var(--bg-secondary);
    padding: 1rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
}

.audio-player audio {
    width: 100%;
    height: 40px;
    border-radius: var(--radius-sm);
}

.transcript-section {
    background: var(--bg-main);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
}

.transcript-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.transcript-header h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
    color: var(--text-primary);
}

.post-transcript {
    background: var(--bg-secondary);
    padding: 1.5rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    line-height: 1.7;
    font-size: 1rem;
    color: var(--text-primary);
    white-space: pre-wrap;
}

.processing-section {
    background: var(--bg-main);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
}

/* Sidebar Widgets */
.stats-widget,
.author-widget,
.actions-widget {
    background: var(--bg-main);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
}

.stats-widget h4,
.author-widget h4,
.actions-widget h4 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.stats-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.stat-item i {
    color: var(--text-muted);
    width: 16px;
}

.stat-label {
    flex: 1;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.stat-value {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 0.875rem;
}

.author-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.author-avatar {
    font-size: 2rem;
    color: var(--primary-main);
}

.author-name {
    font-weight: 500;
    color: var(--text-primary);
}

.author-posts {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.action-buttons {
    display: flex;
    flex-direction: column;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .post-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .post-sidebar {
        order: -1;
    }
}

@media (max-width: 768px) {
    .post-header {
        padding: 1.5rem;
    }
    
    .post-title {
        font-size: 1.5rem;
    }
    
    .post-metadata {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .post-actions {
        flex-direction: column;
    }
    
    .post-actions .btn {
        width: 100%;
    }
    
    .audio-player-section,
    .transcript-section,
    .post-summary-card,
    .stats-widget,
    .author-widget,
    .actions-widget {
        padding: 1rem;
    }
}

/* Loading states */
.audio-player.loading::before {
    content: "Loading audio...";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--text-muted);
    font-size: 0.875rem;
}

.audio-player.error::before {
    content: "Error loading audio";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #EF4444;
    font-size: 0.875rem;
}
</style>

<script>
// Initialize share functionality
function sharePost(title, url) {
    if (navigator.share) {
        navigator.share({
            title: title,
            text: 'Check out this voice post on Voice Log',
            url: url
        }).catch(err => {
            console.log('Error sharing:', err);
            VoiceLog.copyToClipboard(url, 'Link copied to clipboard!');
        });
    } else {
        VoiceLog.copyToClipboard(url, 'Link copied to clipboard!');
    }
}

// Process post functionality
function processPost(slug) {
    VoiceLog.processPost(slug);
}

// Copy to clipboard functionality
function copyToClipboard(text, message) {
    VoiceLog.copyToClipboard(text, message);
}
</script>
{% endblock %}